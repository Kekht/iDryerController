[platformio]
;**************************************************************
;1.  if you use USB ASP and need "WITH_BLACKJACK_AND_HOOKERS"

; - VSCode with configured pio (Platformio CLI) is required! 
; - If this is not possible
; you need an Arduino nano with MiniCore installed
; this can be done by following the instructions
; https://github.com/MCUdude/MiniCore#how-to-install
; in this case steps 1.1 and 1.2 must be skipped

;*********** step 1.1 ************
;default_envs = fuses_bootloader
    ;in terminal
    ;1.1.1  pio run -e fuses_bootloader -t fuses (enter)
    ;1.1.2  pio run -e fuses_bootloader -t bootloader (enter)
    ;1.1.3  next step

;*********** step 1.2 ************
; Connect the Arduino nano
; https://alexgyver.ru/wp-content/uploads/2021/07/usbasp10.jpg

;*********** step 1.3 ************
;copy and run in VSCode terminal
;pio run -e ISP -t upload
;*********** step 1.4 ************
;copy and run in VSCode terminal
;pio run -e EEP -t uploadeep


;**************************************************************
;2 if you don't need safety and WDT;) 
;connect USB to the Arduino nano and upload fimware 

;Run and enjoy)

;default_envs = nanoatmega328new
default_envs = ISP
;default_envs = EEP


[env]
platform = atmelavr
framework = arduino
board_build.f_cpu = 16000000L
; build_unflags = -flto
build_flags = 
monitor_port = ${env:UART.upload_port}
monitor_speed = 9600
lib_deps = 
            ; olikraus/U8g2
            ; miguel5612/ThermistorLibrary
            https://github.com/queuetue/Q2-HX711-Arduino-Library
lib_ignore = Wire1

[env:nanoatmega328new]
upload_protocol = arduino
board = nanoatmega328new
upload_port = ${env:UART.upload_port}
upload_speed = 115200

; pio run -e EEP -t upload
[env:EEP]
platform = atmelavr
board = ATmega328P
framework = arduino
upload_port = usb
upload_protocol = usbasp
upload_flags =
    -C${platformio.packages_dir}/tool-avrdude/avrdude.conf
    -p$BOARD_MCU
    ; -P$UPLOAD_PORT
    -PUSB
    -cusbasp
upload_command = avrdude $UPLOAD_FLAGS -U flash:w:$SOURCE:i
board_upload.extra_flags = 

[env:UART]
upload_protocol = arduino
board = ATmega328P
upload_port = /dev/tty.usbserial-1420
board_upload.speed = ${env:fuses_bootloader.board_bootloader.speed}
; board_upload.speed = 115200

[env:ISP]
upload_protocol = custom
board = ATmega328P
upload_flags =
  -C$PROJECT_PACKAGES_DIR/tool-avrdude/avrdude.conf
  -p$BOARD_MCU
  -PUSB
  -cusbasp
upload_command = avrdude $UPLOAD_FLAGS -U flash:w:$SOURCE:i


; Run the following command to set fuses
; pio run -e fuses_bootloader -t fuses
; Run the following command to set fuses + burn bootloader
; pio run -e fuses_bootloader -t bootloader
[env:fuses_bootloader]
board = ATmega328P
board_hardware.oscillator = external ; Oscillator type
board_hardware.uart = uart0          ; Set UART to use for serial upload
board_bootloader.speed = 115200      ; Set bootloader baud rate
board_hardware.bod = 4.3v            ; Set brown-out detection 4.3v
board_hardware.eesave = yes          ; Preserve EEPROM when uploading using programmer
upload_protocol = usbasp             ; Use the USBasp as programmer
upload_flags =                       ; Select USB as upload port and divide the SPI clock by 8
  -PUSB
  -B8
